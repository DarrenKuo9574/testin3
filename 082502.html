<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ…æš¢å¿«é‹å‹•ï½œå››å¹´ç´šèªæ–‡é—–é—œï¼ˆå¡«å……å¼è©©å¥ï¼‰</title>

<!-- Bootstrap Icons åªç‚ºäº†å°åœ–ç¤ºèˆ‡è¦–è¦ºé»ç¶´ -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
/* =========================================================
   A. å…¨åŸŸèˆ‡RWDè¨­å®šï¼ˆç¬¦åˆéœ€æ±‚ 6ï¼šé¿å…è¼¸å…¥è¶…å‡ºå®¹å™¨ï¼‰
   â€» è«‹å„ªå…ˆä½¿ç”¨ Microsoft JhengHei å­—é«”
========================================================= */
* { box-sizing: border-box; }
html, body { height: 100%; }
body{
  font-family: "Microsoft JhengHei", system-ui, -apple-system, Arial, sans-serif;
  background: radial-gradient(1200px 600px at 20% -10%, #eafff2 0%, #d6fff4 35%, #ccf2ff 65%, #f0fff8 100%);
  color: #245953; margin:0;
}
input, select, textarea { max-width: 100%; }

/* å®¹å™¨èˆ‡å¡ç‰‡ï¼ˆæ´»æ½‘ã€æš–è‰²åæ¸…æ–°é‹å‹•é¢¨ï¼‰ */
.container{ max-width: 980px; margin: 0 auto; padding: 16px; }
.card{
  background:#fff; border:3px solid #b8f0d2; border-radius:22px;
  box-shadow:0 14px 30px rgba(88,198,139,.25); padding:20px; margin:18px 0;
}
h1,h2,h3{ margin:.2em 0 .6em; line-height:1.2; }
h1{ font-size:clamp(28px,4.5vw,44px); color:#16a085; }
h2{ font-size:clamp(22px,3.4vw,32px); color:#0f8c78; }
h3{ font-size:clamp(18px,2.6vw,24px); color:#0c6a5b; }

.badge{
  display:inline-flex; align-items:center; gap:6px;
  font-weight:700; padding:8px 12px; border-radius:999px;
  background:#d7fff1; border:2px dashed #83e6c0; color:#0f8c78;
}

/* ä¸»è¦æŒ‰éˆ•ï¼ˆå¯æ„›æœ‰å½ˆæ€§ï¼‰ */
.btn{
  appearance:none; border:none; cursor:pointer; user-select:none;
  padding:12px 18px; border-radius:16px; font-weight:800; letter-spacing:.5px;
  background: linear-gradient(180deg, #28d9a6, #20c997);
  color:#fff; box-shadow:0 12px 0 #189e76, 0 20px 24px rgba(32,201,151,.35);
  transform:translateY(0); transition: transform .08s ease, box-shadow .08s ease;
}
.btn:hover{ transform:translateY(-2px); box-shadow:0 14px 0 #189e76, 0 26px 28px rgba(32,201,151,.4); }
.btn:active{ transform:translateY(6px); box-shadow:0 6px 0 #189e76, 0 12px 18px rgba(32,201,151,.25); }
.btn.secondary{
  background:linear-gradient(180deg, #74d6ff, #4bc9ff);
  box-shadow:0 12px 0 #2aa3d1, 0 20px 24px rgba(75,201,255,.35);
}

/* è¡¨å–®å€ï¼ˆé–‹å ´è’é›†ç­ç´šï¼åº§è™Ÿï¼å§“åï¼‰ */
.form-grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); }
.input{ display:flex; flex-direction:column; gap:6px; }
.input label{ font-weight:700; font-size:14px; color:#0f8c78; }
.input input, .input select{
  padding:12px 14px; border-radius:12px; border:2px solid #a7eed2; background:#fff; font-size:16px;
}

/* é€²åº¦æ¢èˆ‡å¾—åˆ† */
.progress{ width:100%; height:20px; border-radius:999px; background:#e9fff6; overflow:hidden; border:2px solid #a7eed2;}
.progress>div{ height:100%; width:0%; background: linear-gradient(90deg, #28d9a6, #4bc9ff); transition:width .4s ease; }
.scorebar{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.score{ font-size:20px; font-weight:900; color:#0f8c78; background:#fff; border:2px solid #a7eed2; border-radius:12px; padding:8px 12px; }

/* å¤¥ä¼´ç¾¤åƒ */
.partners{ display:grid; grid-template-columns: repeat(3,1fr); gap:12px; }
.partner{ background:#edfff9; border:2px solid #b8f0d2; border-radius:18px; padding:10px; text-align:center; }
.partner .avatar{ font-size:48px; }
.partner .name{ font-weight:800; color:#0f8c78; }

/* é—œå¡å…ƒä»¶é€šç”¨æç¤º */
.msg{ padding:10px 12px; border-radius:12px; font-weight:700; }
.msg.ok{ background:#e6ffed; color:#0e7a2e; border:2px solid #68d38b; }
.msg.err{ background:#ffe7e6; color:#a72323; border:2px solid #ffa8a3; }

/* é—œå¡ä¸€ï¼šæ‹–æ”¾é…å° */
.word-bank, .def-bank{ display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:10px; }
.token{
  background:#d7fff1; border:2px solid #a7eed2; padding:10px; border-radius:14px; font-weight:800; text-align:center; cursor:grab; user-select:none;
}
.dropzone{ background:#fff; border:2px dashed #a7eed2; padding:12px; border-radius:14px; min-height:56px; }
.dropzone.filled{ border-style:solid; background:#f5fffb; }

/* é—œå¡äºŒï¼šå‹•æ„Ÿå¥ */
.sen{ background:#f0fffb; border:2px solid #b8f0d2; border-radius:14px; padding:12px; margin-bottom:10px; }
.sen select, .sen input{ width:100%; padding:10px; border-radius:12px; border:2px solid #a7eed2; }

/* é—œå¡ä¸‰ï¼ˆæ–°ç‰ˆï¼‰ï¼šå¡«å……å¼å°è©© */
.fill-card{ background:#f6fffd; border:2px solid #b8f0d2; border-radius:16px; padding:12px; }
.blank{
  min-width:120px; display:inline-block; padding:6px 10px; margin:0 4px 6px;
  border:2px dashed #90e9cc; border-radius:10px; background:#fff;
}
.fill-input{
  width:min(240px,100%); padding:10px 12px; border-radius:12px; border:2px solid #a7eed2; font-weight:800; text-align:center;
}
.wordbank{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
.wordchip{
  padding:8px 12px; border-radius:999px; background:#d7fff1; border:2px solid #a7eed2; font-weight:800; cursor:pointer; user-select:none;
}
.preview-poem{
  white-space: pre-line; font-weight:800; color:#0c6a5b; background:#ffffff; border:2px solid #a7eed2; border-radius:12px; padding:10px;
}

/* è¼¸å…¥ç‹€æ…‹ */
.is-correct{ border-color:#6bd48d !important; background:#effff4 !important; }
.is-wrong{ border-color:#ff9ea1 !important; background:#fff2f2 !important; }

/* æŠ½çå€ */
.lottery{ display:none; text-align:center; background:#f0fff8; border:3px solid #b8f0d2; border-radius:22px; padding:16px; }
.ticket{ font-size:40px; }

/* å°è¢å¹•å¾®èª¿ */
@media (max-width: 560px){ .partners{ grid-template-columns:1fr; } }

/* =========================================================
   B. è¿·ä½  Bootswatch ä¸»é¡Œï¼šMintyï¼ˆç²¾ç°¡ï¼‰
   - ä¾éœ€æ±‚(5)(11)ï¼Œæ•´åˆè‡ª bootswatch çš„ Minty è‰²ç³»è¦å‰‡ï¼ˆå£“ç¸®å–æ ¸å¿ƒï¼‰
========================================================= */
:root{
  --bs-primary:#78c2ad; --bs-secondary:#f3969a; --bs-success:#56cc9d;
  --bs-warning:#ffce67; --bs-info:#6cc3d5; --bs-danger:#ff7851;
  --bs-body-color:#2b3e50; --bs-body-bg:#fff;
}
button,.btn{ font-family:"Microsoft JhengHei",Arial,sans-serif; }
.btn:focus{ outline:3px solid rgba(108,195,213,.35); outline-offset:2px; }
input:focus, select:focus, textarea:focus{ outline:3px solid rgba(120,194,173,.25); }

/* =========================================================
   C. å½©å¸¶ç‰¹æ•ˆï¼ˆå®Œæˆ/ä¸­çï¼‰
========================================================= */
.confetti{ position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; overflow:hidden; }
.confetti i{ position:absolute; top:-10px; font-style:normal; animation: fall linear forwards; }
@keyframes fall{ to{ transform: translateY(110vh) rotate(720deg); opacity:.9; } }
</style>
</head>

<body>
<div class="container">
  <!-- é é¦–ï¼šæ¨™é¡Œ + é€²åº¦ + åˆ†æ•¸ -->
  <div class="card">
    <h1><i class="bi bi-lightning-charge-fill"></i> æš¢å¿«é‹å‹•ï½œèªæ–‡é—–é—œ <span class="badge">å››ä¸Šåœ‹èª ç¬¬ä¸€èª² <i class="bi bi-bookmark-heart"></i></span> ğŸ›¼</h1>
    <div class="scorebar">
      <div class="score" id="score">åˆ†æ•¸ï¼š0</div>
      <div class="score">é€²åº¦ï¼š<span id="progressText">0 / 3</span> é—œ</div>
      <div class="progress" style="flex:1; min-width:200px"><div id="progressBar"></div></div>
    </div>
  </div>

  <!-- å¤¥ä¼´ä»‹ç´¹ -->
  <div class="card">
    <h2><i class="bi bi-emoji-smile-fill"></i> é‹å‹•å¤¥ä¼´ä¾†å ±åˆ°ï¼</h2>
    <div class="partners">
      <div class="partner"><div class="avatar">ğŸ‹ï¸â€â™‚ï¸</div><div class="name">é‹å‹•æ•™ç·´ Coach</div><div>æˆ‘æœƒçµ¦ä½ æç¤ºèˆ‡åŠ æ²¹æ‰“æ°£ï¼</div></div>
      <div class="partner"><div class="avatar">ğŸƒâ€â™‚ï¸</div><div class="name">å°ç”·ç”Ÿ é˜¿å‹•</div><div>æˆ‘æœ€æ„›åŠ é€Ÿè¡åˆºï½</div></div>
      <div class="partner"><div class="avatar">ğŸ›¼ğŸƒâ€â™€ï¸</div><div class="name">å°å¥³ç”Ÿ å°æš¢</div><div>è·Ÿè‘—æˆ‘ä¸€èµ·æ»‘è¡Œé¨éŠï¼</div></div>
    </div>
  </div>

  <!-- é–‹å ´è¡¨å–® -->
  <div class="card" id="introCard">
    <h2><i class="bi bi-person-vcard-fill"></i> å…ˆå¡«è³‡æ–™å†é–‹å§‹</h2>
    <div class="form-grid">
      <div class="input"><label>ç­ç´š</label><input id="cls" placeholder="ä¾‹å¦‚ï¼š4å¹´1ç­" /></div>
      <div class="input"><label>åº§è™Ÿ</label><input id="num" type="number" min="1" placeholder="ä¾‹å¦‚ï¼š12" /></div>
      <div class="input"><label>å§“å</label><input id="name" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" /></div>
    </div>
    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" id="btnStart"><i class="bi bi-play-fill"></i> é–‹å§‹é—–é—œ</button>
      <button class="btn secondary" id="btnExport"><i class="bi bi-download"></i> åŒ¯å‡ºä½œç­”ç´€éŒ„ï¼ˆCSVï¼‰</button>
    </div>
    <div id="introMsg" class="msg" style="margin-top:10px;"></div>
  </div>

  <!-- é—œå¡ä¸€ï¼šè©èªå¿«å¿«é…ï¼ˆç¶­æŒä¸è®Šï¼‰ -->
  <div class="card" id="stage1" style="display:none;">
    <h2>é—œå¡ä¸€ <span class="badge"><i class="bi bi-joystick"></i> è©èªå¿«å¿«é…</span> ğŸ¯</h2>
    <p>æŠŠä¸‹åˆ—<strong>è©èª</strong>æ‹–åˆ°æ­£ç¢ºçš„<strong>è§£é‡‹</strong>ä¸Šã€‚åŒ…å«ï¼š<b>æ»‘è¡Œã€åŠ é€Ÿã€é¨éŠã€é£›é·¹ã€ç·©ç·©</b></p>
    <div class="word-bank" id="wordBank"></div>
    <hr style="border:none; border-top:2px dashed #b8f0d2; margin:12px 0;">
    <div class="def-bank" id="defBank"></div>
    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" id="checkS1"><i class="bi bi-check2-square"></i> é€å‡ºé—œå¡ä¸€</button>
      <button class="btn secondary" id="resetS1"><i class="bi bi-arrow-clockwise"></i> é‡ç½®</button>
    </div>
    <div id="s1Msg" class="msg" style="margin-top:10px;"></div>
  </div>

  <!-- é—œå¡äºŒï¼šæŠŠå¥å­å¯«æˆå‹•æ„Ÿå¥ï¼ˆç¶­æŒä¸è®Šï¼‰ -->
  <div class="card" id="stage2" style="display:none;">
    <h2>é—œå¡äºŒ <span class="badge"><i class="bi bi-magic"></i> å‹•æ„Ÿå¥é­”æ³•</span> ğŸª„</h2>
    <p>æŠŠæ™®é€šå¥å­è®Šå¾—æ›´æœ‰ã€Œå‹•æ„Ÿã€ï¼è«‹é¸æ“‡æ›´ç”Ÿå‹•çš„è©èªæˆ–ç‹€æ…‹ã€‚</p>
    <div class="sen">
      1. æˆ‘åœ¨æ“å ´ä¸Šï¼ˆ<b>è·‘æ­¥</b>ï¼‰ã€‚<br>
      <select id="s2a">
        <option value="">â€” é¸æ“‡å‹•æ„Ÿèªªæ³• â€”</option>
        <option>æˆ‘åœ¨æ“å ´ä¸Šé£›å¿«åœ°å¥”è·‘ã€‚</option>
        <option>æˆ‘åœ¨æ“å ´ä¸Šç·©ç·©åœ°èµ°è·¯ã€‚</option>
        <option>æˆ‘åœ¨æ“å ´ä¸Šåœä¸‹ä¾†ä¼‘æ¯ã€‚</option>
      </select>
    </div>
    <div class="sen">
      2. ç›´æ’è¼ªå¾€å‰ï¼ˆ<b>ç§»å‹•</b>ï¼‰ã€‚<br>
      <select id="s2b">
        <option value="">â€” é¸æ“‡å‹•æ„Ÿèªªæ³• â€”</option>
        <option>ç›´æ’è¼ªå‘¼å˜¯è‘—åŠ é€Ÿæ»‘è¡Œã€‚</option>
        <option>ç›´æ’è¼ªåœåœ¨åŸåœ°ä¸å‹•ã€‚</option>
        <option>ç›´æ’è¼ªæ…¢æ…¢å¾€å¾Œé€€ã€‚</option>
      </select>
    </div>
    <div class="sen">
      3. æˆ‘æœ›å‘å¤©ç©ºçš„ï¼ˆ<b>é³¥</b>ï¼‰ã€‚<br>
      <select id="s2c">
        <option value="">â€” é¸æ“‡å‹•æ„Ÿèªªæ³• â€”</option>
        <option>æˆ‘è¿½è‘—åƒé£›é·¹ä¸€æ¨£çš„èº«å½±é¨éŠã€‚</option>
        <option>æˆ‘çœ‹è‘—ä¸€éš»éœæ­¢çš„ç´™é³¥ã€‚</option>
        <option>æˆ‘çœ‹è‘—å¤©ç©ºä¸€ç‰‡ç©ºç™½ã€‚</option>
      </select>
    </div>
    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" id="checkS2"><i class="bi bi-check2-square"></i> é€å‡ºé—œå¡äºŒ</button>
      <button class="btn secondary" id="resetS2"><i class="bi bi-arrow-clockwise"></i> é‡ç½®</button>
    </div>
    <div id="s2Msg" class="msg" style="margin-top:10px;"></div>
  </div>

  <!-- é—œå¡ä¸‰ï¼ˆæ–°ç‰ˆï¼‰ï¼šå¡«å……å¼å°è©©ä»¿ä½œ -->
  <div class="card" id="stage3" style="display:none;">
    <h2>é—œå¡ä¸‰ <span class="badge"><i class="bi bi-chat-left-heart-fill"></i> å°è©©å¡«å……å·¥åŠ</span> âœï¸</h2>
    <p>å¾ä¸‹æ–¹ã€Œå­—è©è£œçµ¦ç«™ã€é»ä¸€ä¸‹å³å¯å¡«å…¥ç©ºæ ¼ï¼ˆä¹Ÿå¯è‡ªè¡Œè¼¸å…¥ï¼‰ã€‚è«‹æŠŠ <b>6 å€‹ç©ºæ ¼</b> å…¨éƒ¨å®Œæˆï¼Œå†é€å‡ºï¼</p>

    <!-- å­—è©è£œçµ¦ç«™ï¼šå¯è‡ªç”±å¢æ¸›é—œéµè©ï¼ˆæŒ‘æˆ°â†‘ï¼‰ -->
    <div class="fill-card">
      <b>å­—è©è£œçµ¦ç«™</b>
      <div class="wordbank" id="wordBankFill">
        <!-- æœƒç”± JS ä¾é™£åˆ—å»ºç«‹ -->
      </div>
    </div>

    <!-- å¥å‹ï¼šå« 6 å€‹ç©ºæ ¼ï¼ˆå¯è¼¸å…¥æˆ–é»é¸å¸¶å…¥ï¼‰ -->
    <div class="fill-card" style="margin-top:10px;">
      <div style="font-weight:800; margin-bottom:6px;">æˆ‘çš„é‹å‹•å°è©©ï¼š</div>
      <div style="line-height:2;">
        æˆ‘ç©¿ä¸Šç›´æ’è¼ªï¼Œ<span class="blank"><input class="fill-input" id="b1" placeholder="ä¾‹ï¼šç·©ç·©ç†±èº«"></span>ã€‚<br>
        åœ¨æ“å ´é‚Šç·£ï¼Œ<span class="blank"><input class="fill-input" id="b2" placeholder="ä¾‹ï¼šè¼•è¼•æ»‘è¡Œ"></span>ï¼Œ<span class="blank"><input class="fill-input" id="b3" placeholder="ä¾‹ï¼šåŠ é€Ÿå‡ºç™¼"></span>ã€‚<br>
        é¢¨åƒ<span class="blank"><input class="fill-input" id="b4" placeholder="ä¾‹ï¼šé£›é·¹"></span>ï¼Œæ›¿æˆ‘é ˜è·¯ï¼Œå¿ƒå¾€å‰<span class="blank"><input class="fill-input" id="b5" placeholder="ä¾‹ï¼šé¨éŠ"></span>ã€‚<br>
        æ±—ç æ»¾è½ï¼Œæˆ‘<span class="blank"><input class="fill-input" id="b6" placeholder="ä¾‹ï¼šç¬‘è‘—å‰é€²"></span>ã€‚
      </div>
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" id="checkS3"><i class="bi bi-check2-square"></i> é€å‡ºé—œå¡ä¸‰</button>
      <button class="btn secondary" id="resetS3"><i class="bi bi-arrow-clockwise"></i> é‡ç½®</button>
    </div>

    <div id="s3Msg" class="msg" style="margin-top:10px;"></div>

    <div class="card" id="poemPreview" style="display:none; margin-top:16px;">
      <h3><i class="bi bi-pencil-square"></i> æˆ‘çš„ä»¿ä½œ</h3>
      <div id="poemText" class="preview-poem"></div>
    </div>
  </div>

  <!-- æŠ½çå€ï¼ˆå®Œæˆä¸‰é—œå¾Œé¡¯ç¤ºï¼‰ -->
  <div class="card lottery" id="lottery">
    <h2><i class="bi bi-gift-fill"></i> å®Œæˆä¸‰é—œï¼æŠ½çæ™‚é–“åˆ° ğŸ</h2>
    <p>æ¯äººé™æŠ½ä¸€æ¬¡ï½ç¥ä½ å¥½æ‰‹æ°£ï¼</p>
    <div class="ticket">ğŸŸï¸</div>
    <div style="margin-top:12px;"><button class="btn" id="btnDraw"><i class="bi bi-stars"></i> æŠ½ä¸€æŠ½</button></div>
    <div id="lotteryMsg" class="msg" style="margin-top:10px;"></div>
  </div>

  <!-- æ•™å¸«èªªæ˜ -->
  <div class="card">
    <h3><i class="bi bi-info-circle-fill"></i> æ•™å¸«å°å¹«æ‰‹</h3>
    <ul>
      <li>ç³»çµ±ä»¥ <b>ç­ç´šï¼‹åº§è™Ÿï¼‹å§“å</b> è­˜åˆ¥å­¸ç”Ÿï¼Œç´€éŒ„é—–é—œçµæœèˆ‡æ˜¯å¦æŠ½çã€‚</li>
      <li>æŒ‰ã€ŒåŒ¯å‡ºä½œç­”ç´€éŒ„ï¼ˆCSVï¼‰ã€å¯ä¸‹è¼‰æœ¬æ©Ÿè’é›†çš„æ‰€æœ‰ç´€éŒ„ã€‚</li>
      <li>ç­”å°/ç­”éŒ¯èˆ‡é€šé—œä½¿ç”¨ <b>Web Audio API</b> å³æ™‚ç”¢ç”ŸéŸ³æ•ˆã€‚</li>
    </ul>
  </div>
</div>

<!-- å½©å¸¶ç‰¹æ•ˆå®¹å™¨ -->
<div class="confetti" id="confetti"></div>

<script>
/* =========================================================
   JS ç¨‹å¼é‚è¼¯ï¼ˆå«è¨»è§£ï¼‰ï¼š
   - A. å…¬ç”¨/éŸ³æ•ˆ/å½©å¸¶/é€²åº¦æ¢
   - B. é–‹å ´è¡¨å–® & åŒ¯å‡ºCSV
   - C. é—œå¡ä¸€ï¼ˆæ‹–æ”¾é…å°ï¼‰
   - D. é—œå¡äºŒï¼ˆå‹•æ„Ÿå¥ï¼‰
   - E. é—œå¡ä¸‰ï¼ˆå¡«å……å¼å°è©©ï¼‰â˜…æ–°ç‰ˆâ˜…
   - F. æŠ½çï¼ˆå®Œæˆä¸‰é—œè§£é–ï¼›æ¯äººé™ä¸€æ¬¡ï¼›15%ï¼‰
========================================================= */

/* ---------- A. å…¬ç”¨ ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

const STATE = { user:null, score:0, done:{s1:false,s2:false,s3:false} };
function userKey(u){ return `Y4_Skate_${u.cls}_${u.num}_${u.name}`; }
function loadUserRecords(){ return JSON.parse(localStorage.getItem('Y4_Skate_Records') || '[]'); }
function saveUserRecord(rec){
  const list = loadUserRecords(); list.push(rec);
  localStorage.setItem('Y4_Skate_Records', JSON.stringify(list));
}
function updateProgress(){
  const n = Number(STATE.done.s1)+Number(STATE.done.s2)+Number(STATE.done.s3);
  $('#progressText').textContent = `${n} / 3`;
  $('#progressBar').style.width = `${(n/3)*100}%`;
  $('#score').textContent = `åˆ†æ•¸ï¼š${STATE.score}`;
  if(STATE.done.s1 && STATE.done.s2 && STATE.done.s3){ $('#lottery').style.display='block'; }
}
function burstConfetti(){
  const c = $('#confetti'); const colors = ['ğŸŸ¡','ğŸŸ¢','ğŸ”µ','ğŸŸ£','ğŸŸ ','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ’›'];
  for(let i=0;i<120;i++){
    const piece=document.createElement('i');
    piece.textContent=colors[Math.floor(Math.random()*colors.length)];
    piece.style.left=(Math.random()*100)+'%';
    piece.style.fontSize=(12+Math.random()*24)+'px';
    piece.style.animationDuration=(2+Math.random()*2)+'s';
    c.appendChild(piece); setTimeout(()=>piece.remove(),4000);
  }
}
function playSound(type='ok'){
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  let seq=[];
  if(type==='ok'){ seq=[440,554.37,659.25]; }
  else if(type==='err'){ seq=[392,261.63]; }
  else if(type==='win'){ seq=[523.25,659.25,783.99,1046.5]; }
  let t=ctx.currentTime;
  seq.forEach(f=>{
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=(type==='win')?'triangle':'sine'; o.frequency.value=f;
    g.gain.setValueAtTime(.0001,t); g.gain.linearRampToValueAtTime(.2,t+.02); g.gain.exponentialRampToValueAtTime(.0001,t+.25);
    o.connect(g); g.connect(ctx.destination); o.start(t); o.stop(t+.27); t+=.12;
  });
}

/* ---------- B. é–‹å ´è¡¨å–® / åŒ¯å‡º ---------- */
$('#btnStart').addEventListener('click', ()=>{
  const cls=$('#cls').value.trim(), num=$('#num').value.trim(), name=$('#name').value.trim();
  if(!cls||!num||!name){ $('#introMsg').className='msg err'; $('#introMsg').textContent='è«‹æŠŠã€Œç­ç´šã€åº§è™Ÿã€å§“åã€å¡«å®Œæ•´å–”ï¼'; playSound('err'); return; }
  STATE.user={cls,num,name}; STATE.user.key=userKey(STATE.user);
  localStorage.setItem('Y4_Skate_CurrentUser', JSON.stringify(STATE.user));
  $('#introMsg').className='msg ok'; $('#introMsg').textContent=`${cls} ${num}è™Ÿ ${name}ï¼Œæº–å‚™å‡ºç™¼ï¼è«‹å®Œæˆæ‰€æœ‰é—œå¡ï½`;
  initStage1(); $('#stage1').style.display='block'; playSound('ok');
});
$('#btnExport').addEventListener('click', ()=>{
  const data=loadUserRecords();
  const header=['æ™‚é–“','ç­ç´š','åº§è™Ÿ','å§“å','é—œå¡','å¾—åˆ†','æ˜¯å¦é€šé','å…§å®¹'];
  const lines=[header.join(',')];
  data.forEach(r=> lines.push([r.time,r.cls,r.num,r.name,r.stage,r.delta,r.pass?'æ˜¯':'å¦', JSON.stringify(r.payload||{})].join(',')));
  const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='å››ä¸Š_æš¢å¿«é‹å‹•_é—–é—œç´€éŒ„.csv'; a.click();
});

/* ---------- C. é—œå¡ä¸€ï¼šæ‹–æ”¾é…å°ï¼ˆç¶­æŒï¼‰ ---------- */
const WORDS=[ {w:'æ»‘è¡Œ',d:'èº«é«”æˆ–ç‰©é«”è²¼è‘—åœ°é¢/ç©ºæ°£å¹³é †åœ°å‰é€²ã€‚'}, {w:'åŠ é€Ÿ',d:'é€Ÿåº¦è®Šå¿«ã€‚'}, {w:'é¨éŠ',d:'è‡ªåœ¨åœ°åˆ°è™•éŠèµ°ã€‚'}, {w:'é£›é·¹',d:'æ¯”å–»æ•æ·ã€æœ‰åŠ›çš„é£›ç¿”èº«å½±ã€‚'}, {w:'ç·©ç·©',d:'æ…¢æ…¢åœ°ã€‚'} ];
let s1Answers={};
function initStage1(){
  const wb=$('#wordBank'); wb.innerHTML=''; WORDS.forEach(item=>{
    const t=document.createElement('div'); t.className='token'; t.textContent=item.w; t.draggable=true; t.dataset.word=item.w;
    t.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', item.w)); wb.appendChild(t);
  });
  const shuffled=[...WORDS].sort(()=>Math.random()-0.5);
  const db=$('#defBank'); db.innerHTML='';
  shuffled.forEach((item,i)=>{
    const z=document.createElement('div'); z.className='dropzone'; z.dataset.index=i;
    z.innerHTML=`<b>è§£é‡‹ ${i+1}</b><br>${item.d}<div class="put" style="margin-top:8px;font-weight:800;color:#0f8c78;"></div>`;
    z.addEventListener('dragover', e=> e.preventDefault());
    z.addEventListener('drop', e=>{ e.preventDefault(); const w=e.dataTransfer.getData('text/plain'); z.querySelector('.put').textContent=w; z.classList.add('filled'); s1Answers[i]=w; });
    db.appendChild(z);
  });
  $('#s1Msg').textContent=''; s1Answers={};
}
$('#checkS1').addEventListener('click', ()=>{
  const defs=Array.from($('#defBank').children).map(z=> z.innerText);
  const bankMap=new Map(); WORDS.forEach(o=> bankMap.set(o.d,o.w));
  let correct=0;
  defs.forEach((txt,i)=>{
    const d=txt.replace(/[\s\S]*è§£é‡‹ \d+\s*/, '').trim();
    const put=$('#defBank').children[i].querySelector('.put').textContent.trim();
    const ans=bankMap.get(d);
    if(put && ans && put===ans){ correct++; $('#defBank').children[i].classList.add('is-correct'); }
    else{ $('#defBank').children[i].classList.add('is-wrong'); }
  });
  const delta=correct*10; STATE.score+=delta; STATE.done.s1=true;
  $('#s1Msg').className='msg '+(correct===5?'ok':'err'); $('#s1Msg').textContent=`æœ¬é—œç­”å° ${correct} / 5 é¡Œï¼Œå¾—åˆ° ${delta} åˆ†ï¼`;
  playSound(correct===5?'ok':'err'); burstConfetti(); updateProgress();
  saveUserRecord({ time:new Date().toLocaleString(), cls:STATE.user.cls, num:STATE.user.num, name:STATE.user.name, stage:'é—œå¡ä¸€', delta, pass:true, payload:{correct} });
  $('#stage2').style.display='block';
});
$('#resetS1').addEventListener('click', initStage1);

/* ---------- D. é—œå¡äºŒï¼šå‹•æ„Ÿå¥ï¼ˆç¶­æŒï¼‰ ---------- */
$('#checkS2').addEventListener('click', ()=>{
  const a=$('#s2a').value, b=$('#s2b').value, c=$('#s2c').value;
  let correct=0;
  if(a==='æˆ‘åœ¨æ“å ´ä¸Šé£›å¿«åœ°å¥”è·‘ã€‚') correct++;
  if(b==='ç›´æ’è¼ªå‘¼å˜¯è‘—åŠ é€Ÿæ»‘è¡Œã€‚') correct++;
  if(c==='æˆ‘è¿½è‘—åƒé£›é·¹ä¸€æ¨£çš„èº«å½±é¨éŠã€‚') correct++;
  const delta=correct*10; STATE.score+=delta; STATE.done.s2=true;
  $('#s2Msg').className='msg '+(correct===3?'ok':'err'); $('#s2Msg').textContent=`æœ¬é—œå®Œæˆï¼å‹•æ„Ÿå¥æ­£ç¢º ${correct} / 3ï¼Œå¾—åˆ° ${delta} åˆ†ã€‚`;
  playSound(correct===3?'ok':'err'); burstConfetti(); updateProgress();
  saveUserRecord({ time:new Date().toLocaleString(), cls:STATE.user.cls, num:STATE.user.num, name:STATE.user.name, stage:'é—œå¡äºŒ', delta, pass:true, payload:{a,b,c} });
  $('#stage3').style.display='block';
});
$('#resetS2').addEventListener('click', ()=>{ $('#s2a').value=''; $('#s2b').value=''; $('#s2c').value=''; $('#s2Msg').textContent=''; });

/* ---------- E. é—œå¡ä¸‰ï¼šå¡«å……å¼å°è©©ï¼ˆæŒ‘æˆ°â†‘ï¼‰ ---------- */
/* è¨­è¨ˆæ€è·¯ï¼š
   - å­—è©è£œçµ¦ç«™æä¾›å¤šå€‹é—œéµè©ï¼Œé»ä¸€ä¸‹æœƒå¡«å…¥ã€Œç›®å‰ç©ºç™½æ ¼ã€æˆ–è¿½åŠ åˆ°ç©ºç™½æ ¼çš„å…§å®¹å°¾ç«¯ã€‚
   - å­¸ç”Ÿä¹Ÿå¯è‡ªè¡Œè¼¸å…¥ï¼ˆæé«˜æŒ‘æˆ°èˆ‡å½ˆæ€§ï¼‰ã€‚
   - è©•åˆ†æ–¹å¼ï¼š
     (1) å…­å€‹ç©ºæ ¼çš†éç©º â†’ åŸºç¤ 10 åˆ†
     (2) æ¯å‡ºç¾ä¸€å€‹é—œéµè© +2 åˆ†ï¼Œä¸Šé™ +20
     (3) è‹¥è‡³å°‘ä½¿ç”¨ 4 å€‹ä¸åŒé—œéµè© â†’ é¡å¤– +5 åˆ†ï¼ˆé¼“å‹µå¤šå…ƒä½¿ç”¨ï¼‰
*/
const KEYWORDS = ['æ»‘è¡Œ','åŠ é€Ÿ','é¨éŠ','é£›é·¹','ç·©ç·©','å¥”è·‘','å‡ºç™¼','å‘¼å˜¯','é ˜è·¯','å‰é€²','ç†±èº«','è¼•è¼•'];
const FIELDS = ['#b1','#b2','#b3','#b4','#b5','#b6'];
let currentFieldIndex = 0; // è¿½è¹¤ç›®å‰èšç„¦çš„ç©ºæ ¼

// å»ºç«‹å­—è©è£œçµ¦ç«™
(function initWordBankFill(){
  const box = $('#wordBankFill'); box.innerHTML='';
  KEYWORDS.forEach(w=>{
    const chip = document.createElement('div');
    chip.className='wordchip';
    chip.textContent=w;
    chip.title='é»ä¸€ä¸‹å¡«å…¥ç›®å‰ç©ºæ ¼ï¼ˆæˆ–è¿½åŠ åˆ°æ–‡å­—å¾Œæ–¹ï¼‰';
    chip.addEventListener('click', ()=>{
      const el = document.querySelector(FIELDS[currentFieldIndex]) || document.querySelector(FIELDS[0]);
      if(el){
        el.value = el.value ? (el.value + w) : w; // ç›´æ¥è¿½åŠ ï¼Œå¢åŠ è¶£å‘³èˆ‡æŒ‘æˆ°
        el.classList.remove('is-wrong'); el.classList.add('is-correct');
        playSound('ok');
      }
    });
    box.appendChild(chip);
  });
})();

// ç›£è½ç©ºæ ¼çš„ focusï¼Œæ›´æ–° currentFieldIndex
FIELDS.forEach((sel, idx)=>{
  document.addEventListener('focusin', (e)=>{ if(e.target && e.target.id === sel.slice(1)) currentFieldIndex = idx; });
});

// çµ„åˆè©©
function buildPoem(){
  const v = FIELDS.map(sel=> $(sel).value.trim());
  return `æˆ‘ç©¿ä¸Šç›´æ’è¼ªï¼Œ${v[0]}ã€‚\nåœ¨æ“å ´é‚Šç·£ï¼Œ${v[1]}ï¼Œ${v[2]}ã€‚\né¢¨åƒ${v[3]}ï¼Œæ›¿æˆ‘é ˜è·¯ï¼Œå¿ƒå¾€å‰${v[4]}ã€‚\næ±—ç æ»¾è½ï¼Œæˆ‘${v[5]}ã€‚`;
}

// æª¢æŸ¥ä¸¦è¨ˆåˆ†
$('#checkS3').addEventListener('click', ()=>{
  const values = FIELDS.map(sel=> $(sel).value.trim());
  // å…­æ ¼çš†éœ€å¡«å¯«
  if(values.some(x=>!x)){
    $('#s3Msg').className='msg err'; $('#s3Msg').textContent='é‚„æœ‰ç©ºæ ¼æ²’å¡«å–”ï¼è«‹æŠŠ 6 å€‹ç©ºæ ¼éƒ½å®Œæˆï½'; playSound('err'); return;
  }
  // è¨ˆç®—é—œéµè©å‘½ä¸­
  const poem = buildPoem();
  let bonus = 0, usedSet = new Set();
  KEYWORDS.forEach(k=>{
    const count = (poem.match(new RegExp(k,'g'))||[]).length;
    if(count>0){ bonus += 2; usedSet.add(k); }
  });
  if(bonus > 20) bonus = 20; // ä¸Šé™
  let delta = 10 + bonus;
  if(usedSet.size >= 4) delta += 5; // å¤šå…ƒä½¿ç”¨åŠ åˆ†

  STATE.score += delta; STATE.done.s3 = true;
  $('#s3Msg').className='msg ok'; $('#s3Msg').textContent=`å¤ªæ£’äº†ï¼å®Œæˆå¡«å……å¼å°è©©ï¼Œå¾—åˆ° ${delta} åˆ†ï¼ˆå«é—œéµè©åŠ åˆ† ${bonus} åˆ†ï¼Œ å¤šå…ƒåŠ åˆ† ${usedSet.size>=4?5:0} åˆ†ï¼‰ã€‚`;
  $('#poemText').textContent = poem; $('#poemPreview').style.display='block';
  playSound('ok'); burstConfetti(); updateProgress();

  // æ¨™è¨˜è¼¸å…¥æ¡†ç‹€æ…‹
  FIELDS.forEach(sel=> { $(sel).classList.add('is-correct'); $(sel).classList.remove('is-wrong'); });

  // ç´€éŒ„
  saveUserRecord({ time:new Date().toLocaleString(), cls:STATE.user.cls, num:STATE.user.num, name:STATE.user.name, stage:'é—œå¡ä¸‰', delta, pass:true, payload:{ poem, used:Array.from(usedSet) }});
});

// é‡ç½®
$('#resetS3').addEventListener('click', ()=>{
  FIELDS.forEach(sel=>{ $(sel).value=''; $(sel).classList.remove('is-correct','is-wrong'); });
  $('#s3Msg').textContent=''; $('#poemPreview').style.display='none'; currentFieldIndex=0;
});

/* ---------- F. æŠ½ç ---------- */
function hasDrawn(u){ return localStorage.getItem(`${u.key}_drawn`) === '1'; }
function setDrawn(u){ localStorage.setItem(`${u.key}_drawn`, '1'); }
$('#btnDraw').addEventListener('click', ()=>{
  if(!STATE.user){ $('#lotteryMsg').className='msg err'; $('#lotteryMsg').textContent='è«‹å…ˆå¡«è³‡æ–™ä¸¦å®Œæˆé—–é—œå–”ï¼'; return; }
  if(!(STATE.done.s1 && STATE.done.s2 && STATE.done.s3)){ $('#lotteryMsg').className='msg err'; $('#lotteryMsg').textContent='é‚„æ²’å®Œæˆä¸‰é—œï½åŠ æ²¹ï¼'; return; }
  if(hasDrawn(STATE.user)){ $('#lotteryMsg').className='msg err'; $('#lotteryMsg').textContent='æ¯äººé™æŠ½ä¸€æ¬¡ï¼Œå·²ä½¿ç”¨éå›‰ï¼'; playSound('err'); return; }
  const win = Math.random() < 0.15; setDrawn(STATE.user);
  if(win){
    $('#lotteryMsg').className='msg ok'; $('#lotteryMsg').innerHTML='ğŸ‰ æ­å–œä¸­çï¼ç²å¾— <b>é‡‘è‰²çç« </b> èˆ‡å°ç¦®ç‰©ï¼ˆç”±è€å¸«ç™¼æ”¾ï¼‰ï½';
    playSound('win'); burstConfetti();
    saveUserRecord({ time:new Date().toLocaleString(), cls:STATE.user.cls, num:STATE.user.num, name:STATE.user.name, stage:'æŠ½ç', delta:0, pass:true, payload:{result:'win'}});
  }else{
    $('#lotteryMsg').className='msg err'; $('#lotteryMsg').textContent='å·®ä¸€é»é»ï½ä¸‹æ¬¡å†ä¾†æŒ‘æˆ°ï¼';
    playSound('err');
    saveUserRecord({ time:new Date().toLocaleString(), cls:STATE.user.cls, num:STATE.user.num, name:STATE.user.name, stage:'æŠ½ç', delta:0, pass:false, payload:{result:'lose'}});
  }
});

/* ---------- G. å›å¡«ä½¿ç”¨è€…ï¼ˆé‡æ–°æ•´ç†ä¿ç•™ï¼‰ ---------- */
(function restoreUser(){
  try{
    const u = JSON.parse(localStorage.getItem('Y4_Skate_CurrentUser')||'null');
    if(u){ $('#cls').value=u.cls; $('#num').value=u.num; $('#name').value=u.name; STATE.user=u; }
  }catch(e){}
})();
</script>
</body>
</html>
